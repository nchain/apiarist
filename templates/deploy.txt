#!/bin/sh

# Create the root directory and geth / metrics directories
sudo mkdir -p {{ paths.root }}

{% if containers.geth_goerli %}
    sudo mkdir -p {{ paths.root }}/ethereum
{% endif %}

{% if containers.prometheus %}
    sudo mkdir -p {{ paths.root }}/prometheus
{% endif %}

# Create all the data directories for the bees to store their tasty honey
{% for i in range(num_nodes) %}
    sudo mkdir -p {{ paths.root }}/bee-{{ loop.index }}
    sudo chown 999:999 {{ paths.root }}/bee-{{ loop.index }}
    sudo chmod 755 {{ paths.root }}/bee-{{ loop.index }}
{% endfor %}

# Let's setup clef to make sure it does it's job co-ordinating for our bees
{% if containers.clef %}
    sudo mkdir -p {{ paths.root }}/clef/keystore
    sudo mv ./UTC* {{ paths.root }}/clef/keystore/
    sudo cp password {{ paths.root }}/clef/password
    sudo chown 65534:0 -R {{ paths.root }}/clef
    sudo chmod 750 {{ paths.root }}/clef
    sudo sh -c "chmod -R 0600 {{ paths.root }}/clef/keystore/UTC*"
    sudo mv password {{ paths.root }}/password
{% endif %}
sudo sh clef.sh

# Setup permissions for metrics gathering
[ -d "{{ paths.root }}/prometheus" ] && sudo chown 65534:65534 {{ paths.root }}/prometheus
[ -d "{{ paths.root }}/prometheus" ] && sudo chmod 755 {{ paths.root }}/prometheus
[ -f "{{ paths.root }}/password" ] && sudo chmod 777 {{ paths.root }}/password

chmod +x monBee.sh

docker-compose up -d

#cat tearsheet.txt